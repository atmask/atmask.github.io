<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Immich: Up &amp; Running | Ben Mask</title>
<meta name="keywords" content="immich, postgres, kubernetes, homelab, storage, SMB, NFS">
<meta name="description" content="Overview
I recently started hosting Immich on my homelab. If you&rsquo;re not familiar with Immich, it is a self-hosted Google Photos replacement.
If you want to learn more I highly reccomend giving a listen to this podcast interview with the creator of Immich on the Self-Hosted podcast.
The goal of this post is to cover how I set this up and some of the obstacles I faced in the process.
Immich Architecture and Storage
There wasn&rsquo;t much to plan out before deploying Immich. The main pain point came with respect to getting Postgres running up on my cluster prior to deploying Immich which I&rsquo;ll cover more below.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/14-immich/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/14-immich/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Ben Mask (Alt + H)">Ben Mask</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Immich: Up &amp; Running
    </h1>
    <div class="post-meta"><span title='2025-12-14 22:43:07 -0500 EST'>December 14, 2025</span>&nbsp;·&nbsp;4 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#immich-architecture-and-storage" aria-label="Immich Architecture and Storage">Immich Architecture and Storage</a><ul>
                        
                <li>
                    <a href="#components" aria-label="Components">Components</a></li>
                <li>
                    <a href="#datastores" aria-label="Datastores">Datastores</a><ul>
                        
                <li>
                    <a href="#postgres" aria-label="Postgres">Postgres</a></li>
                <li>
                    <a href="#redis" aria-label="Redis">Redis</a></li>
                <li>
                    <a href="#photo-storage" aria-label="Photo Storage">Photo Storage</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#hurddles-lessons-learned-and-gotchas" aria-label="Hurddles, Lessons Learned, and Gotchas">Hurddles, Lessons Learned, and Gotchas</a><ul>
                        <ul>
                        
                <li>
                    <a href="#configuring-postgres-correctly-for-immich" aria-label="Configuring Postgres Correctly for Immich">Configuring Postgres Correctly for Immich</a></li>
                <li>
                    <a href="#postgres-needs-posix-semantics" aria-label="Postgres Needs Posix Semantics">Postgres Needs Posix Semantics</a></li>
                <li>
                    <a href="#watch-out-for-nginx-upload-limits" aria-label="Watch out for NGINX Upload Limits">Watch out for NGINX Upload Limits</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#what-ive-learning-writing-this-post" aria-label="What I&rsquo;ve learning Writing this Post">What I&rsquo;ve learning Writing this Post</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h1>
<p>I recently started hosting <a href="https://github.com/immich-app">Immich</a> on my homelab. If you&rsquo;re not familiar with Immich, it is a self-hosted Google Photos replacement.
If you want to learn more I highly reccomend giving a listen to <a href="https://selfhosted.show/110?t=1198">this podcast interview</a> with the creator of Immich on the Self-Hosted podcast.</p>
<p>The goal of this post is to cover how I set this up and some of the obstacles I faced in the process.</p>
<h1 id="immich-architecture-and-storage">Immich Architecture and Storage<a hidden class="anchor" aria-hidden="true" href="#immich-architecture-and-storage">#</a></h1>
<p>There wasn&rsquo;t much to plan out before deploying Immich. The main pain point came with respect to getting Postgres running up on my cluster prior to deploying Immich which I&rsquo;ll cover more below.</p>
<h2 id="components">Components<a hidden class="anchor" aria-hidden="true" href="#components">#</a></h2>
<p>Immich ships two workloads:</p>
<ul>
<li>
<p><strong>server:</strong> This is the primary Immich server. It&rsquo;s written in Typescript, manages database operations, serves the web client (built with SvelteKit), and coordinates with the machine learning workload.</p>
</li>
<li>
<p><strong>machine learning:</strong> This workload is an HTTP Python service using FastAPI. It processes images running facial detection, recognition, and OCR.</p>
</li>
</ul>
<h2 id="datastores">Datastores<a hidden class="anchor" aria-hidden="true" href="#datastores">#</a></h2>
<h3 id="postgres">Postgres<a hidden class="anchor" aria-hidden="true" href="#postgres">#</a></h3>
<p>Immich requires a backing Postgres database for storing all user data and media metadata. However, the official Helm chart for Immich does not ship with a postgres deployment to get up and running.</p>
<p>Given that I will likely have other applications use Postgres for their backing database in the future I decided to investigate Postgres operators for managing Postgres installations on my cluster. After some brief searching it appeared that general concensus was that <a href="https://cloudnative-pg.io/">CloudNative Postgres</a> (CNPG) was the encumbent Postgres operator of choice.</p>
<h3 id="redis">Redis<a hidden class="anchor" aria-hidden="true" href="#redis">#</a></h3>
<p>The official Immich chart deploys with Valkey as a dependency. Valkey, which is a Redis compatible caching service, is used as the broker for BullMQ for job queues.</p>
<h3 id="photo-storage">Photo Storage<a hidden class="anchor" aria-hidden="true" href="#photo-storage">#</a></h3>
<p>Photos are stored to my external SMB share running from TrueNas. I have a few free TB here that should be sufficient to get me started.</p>
<h1 id="hurddles-lessons-learned-and-gotchas">Hurddles, Lessons Learned, and Gotchas<a hidden class="anchor" aria-hidden="true" href="#hurddles-lessons-learned-and-gotchas">#</a></h1>
<h3 id="configuring-postgres-correctly-for-immich">Configuring Postgres Correctly for Immich<a hidden class="anchor" aria-hidden="true" href="#configuring-postgres-correctly-for-immich">#</a></h3>
<p>There is no very well-documented configurations at the moment for how to set up Postgres for Immich. I believe part of this is due the recent migration Immich underwent away from the pgvecto.rs extension to vectorchord leacing lots of material outdated. In addition to this, I had to figure out how to map all of these configurations properly to the cnpg <code>Cluster</code> CRD&rsquo;s spec.</p>
<p>After some trial and error I was able to get a working spec for the backing postgres instance with the vectorchore extension:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">immich-database</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageClass</span>: <span style="color:#ae81ff">truenas-postgres</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">5Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imageName</span>: <span style="color:#ae81ff">ghcr.io/tensorchord/cloudnative-vectorchord:16.9-0.4.3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">postgresql</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shared_preload_libraries</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;vchord.so&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">managed</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: { { <span style="color:#ae81ff">.Values.database.user.username } }</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">superuser</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">login</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bootstrap</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initdb</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">database</span>: { { <span style="color:#ae81ff">.Values.database.user.database } }</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">owner</span>: { { <span style="color:#ae81ff">.Values.database.user.username } }</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: { { <span style="color:#ae81ff">.Values.database.user.secretName } }</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postInitSQL</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">CREATE EXTENSION vchord CASCADE;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">CREATE EXTENSION earthdistance CASCADE;</span>
</span></span></code></pre></div><p>The user creds can be configured in a referenced secret as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: { { <span style="color:#ae81ff">.Values.database.user.secretName } }</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stringData</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: { { <span style="color:#ae81ff">.Values.database.user.username | quote } }</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: { { <span style="color:#ae81ff">.Values.database.user.password | quote } }</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">database</span>: { { <span style="color:#ae81ff">.Values.database.user.database | quote } }</span>
</span></span></code></pre></div><h3 id="postgres-needs-posix-semantics">Postgres Needs Posix Semantics<a hidden class="anchor" aria-hidden="true" href="#postgres-needs-posix-semantics">#</a></h3>
<p>I have largely been using a storage class backed by the SMB CSI driver for persistent storage. Without much thought on the weekend that I went to deploy Immich I deployed Postgres using the same storage class. This was when I learned that Postgres cannot run on top of SMB due to the lack of POSIX semantics supported by SMB (make sense. Windows.). So, <a href="https://www.hanselman.com/blog/yak-shaving-defined-ill-get-that-done-as-soon-as-i-shave-this-yak">in the fashion of Yak shaving</a>, I deployed the NFS CSI driver to my cluster and then created and NFS share from TrueNAS. After this was tested and working from my local machine I created the new storageclass with access to the NFS share. Postgres was then satisfied.</p>
<h3 id="watch-out-for-nginx-upload-limits">Watch out for NGINX Upload Limits<a hidden class="anchor" aria-hidden="true" href="#watch-out-for-nginx-upload-limits">#</a></h3>
<p>Migrating away from Nginx for ingress will be on my list at some point ahead of the 2026 retirement but for now as I&rsquo;m using it I will mention the need for the following annotation:</p>
<pre tabindex="0"><code>nginx.ingress.kubernetes.io/proxy-body-size: &#34;0&#34;
</code></pre><p>This removes the body limit from the proxy on file uploads</p>
<h1 id="what-ive-learning-writing-this-post">What I&rsquo;ve learning Writing this Post<a hidden class="anchor" aria-hidden="true" href="#what-ive-learning-writing-this-post">#</a></h1>
<p>Even while writing this post there&rsquo;s a few things I&rsquo;ll have to revist sometime later as there&rsquo;s only so much time you get for hobbies. These are a few:</p>
<ul>
<li>I&rsquo;m curious how well the machine learning workload is running on my underpowered machines? I should take a look at my Grafan cloud instance to see and maybe do some optimizations</li>
<li>I want to do a deeper dive into block storage, object storage, file stroage and all of the nuances in their implementations. Maybe iSCSI would have been better in this case as the POSIX semantics issue would have been offloaded from TrueNAS. These are nuances that I&rsquo;m glad to be learning though and mistakes I can afford to make in this environment.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/immich/">Immich</a></li>
      <li><a href="http://localhost:1313/tags/postgres/">Postgres</a></li>
      <li><a href="http://localhost:1313/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="http://localhost:1313/tags/homelab/">Homelab</a></li>
      <li><a href="http://localhost:1313/tags/storage/">Storage</a></li>
      <li><a href="http://localhost:1313/tags/smb/">SMB</a></li>
      <li><a href="http://localhost:1313/tags/nfs/">NFS</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/15-steph-ango/">
    <span class="title">« Prev</span>
    <br>
    <span>Discovering Steph Ango</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/13-mysql-icp/">
    <span class="title">Next »</span>
    <br>
    <span>Index Condition Pushdown Optimization in MySQL</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Ben Mask</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>



<style>
  img[src$='#wide'] {
    display: block;
    width: 80vw;
    max-width: none;
    margin-left: 50%;
    transform: translateX(-50%);
    border-radius: 0;
  }
</style>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
